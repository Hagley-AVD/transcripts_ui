<?php


function transcripts_ui_tiers() {
	return variable_get('transcripts_ui_tiers', array());
}

function transcripts_ui_init() {
	drupal_add_library('system', 'ui.button');
	drupal_add_library('system', 'jquery.bbq');
}

function transcripts_ui_permission() {
        $permissions = array();
        $permissions['view transcripts'] = array(
                'title' => t('View transcripts'),
        );
        $permissions['administer transcripts ui'] = array(
                'title' => t('Administer ui'),
        );
        return $permissions;
}

function transcripts_ui_menu() {
        $items = array();

	$items['admin/config/user-interface/transcripts'] = array(
		'title' => 'Transcripts UI',
		'description' => 'Administer Transcripts',
    		'page callback' => 'drupal_get_form',
		'page arguments' => array('transcripts_ui_admin'),
                'access arguments' => array('administer transcripts ui'),
		'file' => 'transcripts_ui.admin.inc',
  	);
        $items['admin/config/user-interface/transcripts/ui'] = array(
                'title' => 'Transcripts UI',
                'description' => t('Transcripts UI settings'),
                'page callback' => 'drupal_get_form',
                'page arguments' => array('transcripts_ui_admin'),
                'access arguments' => array('administer transcripts ui'),
                'file' => 'transcripts_ui.admin.inc',
		'type' => MENU_DEFAULT_LOCAL_TASK,
		'weight' => -20,
        );

        return $items;
}

function transcripts_ui_theme() {
	return array(
		'transcripts_ui_interactive_transcript' => array(
			'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
			'template' => 'transcripts-ui-interactive-transcript',
		),
                'transcripts_ui_transcript_controls' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
			'render element' => 'element',
                ),
                'transcripts_ui_video_controls' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
			'render element' => 'element',
                ),
		'transcripts_ui_video_tag' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
			'variables' => array(
				'tag_type' => 'video',
				'video_url' => array(),
				'video_tag' => NULL,
			),
		),
		'transcripts_ui_play_transcript' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
			'file' => 'transcripts_ui.theme.inc',
		),
                'transcripts_ui_previous_tcu' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
                ),
                'transcripts_ui_same_tcu' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
                ),
		'transcripts_ui_next_tcu' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
                ),
                'transcripts_ui_playmode' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
                ),
		'transcripts_ui_hit_summary' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
		),	
		'transcripts_ui_tcu_info' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
			'variables' => array(
				'show_speakers' => FALSE,
				'speaker_name' => '',
				'start_time' => 0,
				'end_time' => 0,
			),
		),
		'transcripts_ui_tcu_tier' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',		
			'variables' => array(
				'tier_name' => '',
				'tier_text' => '',
				'classes' => '',
			),
		),
                'transcripts_ui_goto_tcu' => array(
                        'path' => drupal_get_path('module', 'transcripts_ui') . '/theme',
                        'file' => 'transcripts_ui.theme.inc',
                        'render element' => 'element',
                ),
	);
}

function transcripts_ui_ui($trid, $options) {
	$ui = new TranscriptUI($trid, $options);
	return $ui;
}

function transcripts_ui_mode_selector($form, &$form_state, $trid, $modes) {
	$form = array();
	
	$form['mode_selector'] = array(
		'#type' => 'select',
		'#title' => t('Views'),
		'#options' => $modes,
		'#attributes' => array('class' => array('mode-select')),
	);
	$form['#attributes'] = array(
		'class' => array('mode-selector'),
		'data-trid' => $trid,
	);
	$form['#attached']['js'] = array(drupal_get_path('module', 'transcripts_ui') .'/js/mode_selector.js');
	
	return $form;
}

function transcripts_ui_tier_selector($form, &$form_state, $trid, $tiers) {
	$form = array();
	
	$form['tier_selector'] = array(
		'#type' => 'select',
		'#multiple' => true,
		'#title' => t('Tiers'),
		'#options' => $tiers,
	);
	$form['#attributes'] = array(
		'class' => array('tier-selector'),
		'data-trid' => $trid,
	);
	$form['#attached']['js'] = array(drupal_get_path('module', 'transcripts_ui') .'/js/tier_selector.js');
	
	return $form;
}

function transcripts_ui_search_form($form, &$form_state, $trid, $options) {
  // Loads the core Search CSS file, use the core search module's classes.
  drupal_add_css(drupal_get_path('module', 'search') . '/search.css');

  $bootstrap = variable_get('transcripts_ui_markup', 'default') == 'bootstrap' ? TRUE : FALSE;

  $form = array();
  $form['#id'] = 'transcripts-ui-search-form';
  $form['#attributes']['class'] = array('transcripts-ui-search-form', 'clearfix');
  $form['basic'] = array(
    '#type' => 'container',
  );
  $key = '';
  if (strlen($options['term']) > 0) {
    $key = substr($options['term'], 1, -1);
  }
  $form['basic']['wrapper'] = array(
	'#prefix' => "<div class='input-group'>",
	'keys' => array(
		'#theme_wrappers' => array(),
		'#type' => 'textfield',
    		'#default_value' => $key,
    		'#size' => 20,
    		'#maxlength' => 255,
		'#attributes' => array('placeholder' => t('Search this transcript')),
  	),
	'submit' => array(
		'#prefix' => "<span class='input-group-btn'>",
		'#type' => 'submit',
		'#value' => t('Search'),
		'#inner' => "<span class='glyphicon glyphicon-search'></span>",
       		'#ajax' => array(
       		        'callback' => 'transcripts_ui_ajax_hits',
               		'wrapper' => 'transcripts-ui-hit-list-'.$trid,
			'progress' => array('type' => 'none'),
			'event' => 'click',
       		),
		'#post_render' => array('replace_inner'),
		'#suffix' => "</span>",
	),
	'#suffix' => "</div>",
  );
  $form['trid'] = array(
	'#type' => 'hidden',
	'#value' => substr($trid, 5), //chop of trid- prefix
  );

  $form['basic']['get'] = array(
    '#type' => 'hidden',
    '#default_value' => json_encode(array_diff_key($_GET, array('q' => 1, 'page' => 1, 'solrsort' => 1, 'retain-filters' => 1))),
  );


  $fq = NULL;

  if ($fq || isset($form_state['input']['retain-filters'])) {
    $form['basic']['retain-filters'] = array(
      '#type' => 'checkbox',
      '#title' => t('Retain current filters'),
      '#default_value' => (int) !empty($_GET['retain-filters']),
    );
  }

  return $form;
}

function transcripts_ui_ajax_hits($form, &$form_state) {
	$trid = $form_state['values']['trid'];
	$options = array(
		'term' => $form_state['values']['keys'],
		'hits_only' => TRUE,
	);
	$ui = transcripts_ui_ui($trid, $options);
        foreach (module_implements('transcripts_ui_ajax_search') as $module) {
        	$function = $module . '_transcripts_ui_ajax_search';
        	$function($ui);
        }
	return drupal_render($ui->ui['hits']);
}

function replace_inner($markup, $element) {
	$find = ">" .$element['#value']. "<";
	$replace = ">" .$element['#inner']. "<"; 
	$markup = str_replace($find, $replace, $markup);
	return $markup;
}
